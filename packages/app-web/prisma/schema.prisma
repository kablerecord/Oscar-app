generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [uuid_ossp(map: "uuid-ossp", schema: "extensions"), vector]
}

// =============================================================================
// NOTE: Enterprise Multi-User Support (V1.5+)
// =============================================================================
// Current schema is single-user per workspace (ownerId on Workspace).
// Enterprise multi-user (Organization/Team model) is documented but NOT built.
//
// See: docs/enterprise/specs/ENTERPRISE_TIER_SPEC.md for proposed schema
// See: docs/enterprise/ENTERPRISE_INTEGRATION_STATUS.md for full context
//
// Resume trigger: V1.5 cycle OR enterprise prospect ready for pilot
// Workaround for pilot: Shared login credentials
// =============================================================================

model User {
  id                   String                  @id @default(cuid())
  email                String                  @unique
  name                 String?
  password             String?
  image                String?
  encryptionKey        Json? // Wrapped DEK for per-user encryption (v1.1)
  ceremonySeen         Json? // Tracks which tier ceremonies have been shown: { pro?: boolean, master?: boolean }
  referralCode         String?                 @unique // User's personal referral code
  referralBonusPercent Int                     @default(0) // Accumulated token bonus (5% per successful referral, max 50%)
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  accounts             Account[]
  sessions             Session[]
  settings             UserSetting[]
  workspaces           Workspace[]
  insightPreferences   UserInsightPreferences?
  artifacts            Artifact[]
  referralsMade        Referral[]              @relation("ReferralsMade")
  referralsReceived    Referral[]              @relation("ReferralsReceived")
  labMember            LabMember?

  @@index([email])
  @@index([referralCode])
}

model Workspace {
  id                    String                 @id @default(cuid())
  name                  String
  ownerId               String
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  onboardingCompleted   Boolean                @default(false)
  onboardingCompletedAt DateTime?
  tier                  String                 @default("starter") // Throttle tier: starter, pro, master, enterprise
  tierUpdatedAt         DateTime?              // When tier was last changed (for proration)
  capabilityAssessedAt  DateTime?
  capabilityLevel       Int                    @default(0)
  identityStage         String?
  agents                Agent[]
  artifacts             Artifact[]
  capabilityHistory     CapabilityAssessment[]
  threads               ChatThread[]
  documents             Document[]
  insights              Insight[]
  mscCategories         MSCCategory[]
  mscItems              MSCItem[]
  profileAnswers        ProfileAnswer[]
  projects              Project[]
  owner                 User                   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([capabilityLevel])
  @@index([tier])
}

model Project {
  id          String       @id @default(cuid())
  workspaceId String
  name        String
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  threads     ChatThread[]
  documents   Document[]
  workspace   Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
}

model Document {
  id               String          @id @default(cuid())
  workspaceId      String
  projectId        String?
  title            String
  sourceType       String
  originalFilename String?
  mimeType         String?
  textContent      String
  contentHash      String?         // SHA-256 hash of content for duplicate detection
  metadata         Json?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  project          Project?        @relation(fields: [projectId], references: [id])
  workspace        Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  chunks           DocumentChunk[]

  @@index([workspaceId])
  @@index([projectId])
  @@index([sourceType])
  @@index([workspaceId, contentHash]) // For fast duplicate checking
}

model DocumentChunk {
  id         String                 @id @default(cuid())
  documentId String
  content    String
  embedding  Unsupported("vector")?
  chunkIndex Int
  createdAt  DateTime               @default(now())
  document   Document               @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
}

model ChatThread {
  id          String        @id @default(cuid())
  workspaceId String
  projectId   String?
  title       String
  mode        String        @default("panel")
  status      String        @default("active")  // "active" | "ended" | "archived"
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  endedAt     DateTime?                         // When conversation ended (for Learning Layer)
  metadata    Json?                             // Additional metadata (import info, etc.)
  messages    ChatMessage[]
  project     Project?      @relation(fields: [projectId], references: [id])
  workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([projectId])
  @@index([updatedAt])
  @@index([status])
}

model ChatMessage {
  id        String     @id @default(cuid())
  threadId  String
  role      String
  provider  String?
  agentId   String?
  content   String
  metadata  Json?
  createdAt DateTime   @default(now())
  agent     Agent?     @relation(fields: [agentId], references: [id])
  thread    ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  quickReactions QuickReaction[]

  @@index([threadId])
  @@index([agentId])
  @@index([createdAt])
}

model Agent {
  id           String        @id @default(cuid())
  workspaceId  String
  name         String
  description  String?
  provider     String
  modelName    String
  systemPrompt String
  isDefault    Boolean       @default(false)
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  workspace    Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  messages     ChatMessage[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@index([isActive])
}

model UserSetting {
  id     String @id @default(cuid())
  userId String
  key    String
  value  Json
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, key])
  @@index([userId])
}

model ProfileAnswer {
  id          String    @id @default(cuid())
  workspaceId String
  questionId  String
  category    String
  question    String
  answer      String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, questionId])
  @@index([workspaceId])
  @@index([category])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model UsageRecord {
  id           String   @id @default(cuid())
  userId       String
  endpoint     String
  date         DateTime @db.Date
  requestCount Int      @default(0)
  tokenCount   Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, endpoint, date])
  @@index([userId])
  @@index([date])
}

model RateLimitEvent {
  id        String   @id @default(cuid())
  userId    String?
  ip        String
  endpoint  String
  timestamp DateTime @default(now())

  @@index([userId, timestamp])
  @@index([ip, timestamp])
  @@index([endpoint, timestamp])
}

// ============================================
// Render System Artifacts (V1.5)
// @see docs/features/RENDER_SYSTEM_SPEC.md
// ============================================

model Artifact {
  id            String        @id @default(cuid())
  userId        String
  workspaceId   String?

  // Type and content
  type          ArtifactType
  title         String?
  content       Json          // Type-specific content (ImageArtifactContent | ChartArtifactContent)
  metadata      Json?         // Additional metadata

  // Conversation linking
  conversationId String?      // Links to originating conversation (threadId)
  messageId      String?      // Links to specific message that created it

  // Versioning
  version       Int           @default(1)
  parentId      String?       // Previous version
  parent        Artifact?     @relation("ArtifactVersions", fields: [parentId], references: [id])
  children      Artifact[]    @relation("ArtifactVersions")

  // State machine
  state         RenderState   @default(IDLE)

  // Telemetry (for debugging and future implicit detection)
  provider      String?       // 'openai', etc.
  model         String?       // 'dall-e-3', etc.
  latencyMs     Int?          // Time to generate
  attemptCount  Int           @default(1)  // Number of attempts (retries)
  errorCode     String?       // Sanitized error code
  errorMessage  String?       // Sanitized error message
  promptHash    String?       // Hash of prompt for duplicate detection

  // Timestamps
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  viewedAt      DateTime?

  // Relations
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace     Workspace?    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([workspaceId])
  @@index([type])
  @@index([conversationId])
  @@index([state])
  @@index([createdAt])
}

enum ArtifactType {
  IMAGE
  CHART
  TEMPLATE  // v1.5.1: Template-based artifacts (listings, table, game)
  CODE      // Source code (any language)
  DOCUMENT  // Markdown/text documents
  DIAGRAM   // Mermaid diagrams
  HTML      // HTML/CSS/JS (renderable)
  SVG       // SVG graphics
  JSON      // Structured JSON data
  CSV       // Tabular data
  REACT     // React component (preview in sandbox)
  // UI_GAME â€” deferred to v1.6+
}

enum RenderState {
  IDLE
  RENDERING
  COMPLETE_AWAITING_VIEW
  VIEWING
  UPDATING
  ERROR
  CANCELLED
}

model CapabilityAssessment {
  id          String    @id @default(cuid())
  workspaceId String
  level       Int
  stage       String?
  assessedAt  DateTime  @default(now())
  triggers    String[]
  answers     Json?
  notes       String?
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([assessedAt])
  @@index([level])
}

model MSCItem {
  id          String    @id @default(cuid())
  workspaceId String
  category    String // 'goal', 'project', 'idea', or custom category id
  content     String // Title/main content
  description String? // Optional expanded description/notes
  isPinned    Boolean   @default(false)
  sortOrder   Int       @default(0)
  status      String    @default("active") // 'active', 'in_progress', 'completed', 'archived'
  dueDate     DateTime? // Optional due date for goals/projects
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([category])
  @@index([isPinned])
  @@index([status])
}

// Custom categories for MSC
model MSCCategory {
  id          String    @id @default(cuid())
  workspaceId String
  name        String // Display name
  icon        String    @default("folder") // Lucide icon name
  color       String    @default("text-gray-600") // Tailwind color class
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, name])
  @@index([workspaceId])
}

// Access Codes for early access signup
model AccessCode {
  id        String    @id @default(cuid())
  code      String    @unique
  label     String? // Who this code is for (e.g., "Jesse", "Mom")
  maxUses   Int       @default(1) // How many times this code can be used
  useCount  Int       @default(0) // How many times it's been used
  usedBy    String[] // Emails of users who used it (array for multi-use codes)
  expiresAt DateTime? // Optional expiration date for time-limited codes
  createdAt DateTime  @default(now())

  @@index([code])
  @@index([expiresAt])
}

// Password Reset Tokens (v1.1)
model PasswordResetToken {
  id        String    @id @default(cuid())
  email     String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([email])
  @@index([token])
  @@index([expiresAt])
}

// Background Tasks (J-3)
model BackgroundTask {
  id           String    @id @default(cuid())
  type         String // Task type identifier
  payload      Json // Task-specific data
  workspaceId  String
  status       String    @default("pending") // pending, running, completed, failed, cancelled
  priority     String    @default("normal") // low, normal, high, critical
  scheduledFor DateTime  @default(now())
  startedAt    DateTime?
  completedAt  DateTime?
  error        String?
  result       Json?
  retries      Int       @default(0)
  maxRetries   Int       @default(3)
  timeoutMs    Int       @default(300000) // 5 minutes
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([workspaceId])
  @@index([status])
  @@index([scheduledFor])
  @@index([priority])
}

// ============================================
// TIL Proactive Insights System
// ============================================

// Persisted insights for tracking and learning
model Insight {
  id          String    @id @default(cuid())
  workspaceId String
  category    String // contradiction, clarify, next_step, recall
  priority    Int // 1-10 priority score
  confidence  Float     @default(0.5) // How confident we are in this insight
  title       String // Short title shown in bubble
  message     String // Brief message (bubble view)
  context     Json? // Source data and context
  status      String    @default("queued") // queued, surfaced, dismissed, engaged, expired
  createdAt   DateTime  @default(now())
  expiresAt   DateTime // When insight becomes stale
  surfacedAt  DateTime? // When shown to user
  engagedAt   DateTime? // When user clicked "tell me more"
  dismissedAt DateTime? // When user dismissed
  feedback    Json? // Rating, reason, etc.
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, status])
  @@index([workspaceId, expiresAt])
  @@index([workspaceId, category])
}

// User preferences for insight delivery
model UserInsightPreferences {
  id                String   @id @default(cuid())
  userId            String   @unique
  bubbleMode        String   @default("on") // on, off, quiet
  maxPerHour        Int      @default(3) // Interrupt budget
  maxPerSession     Int      @default(10)
  // Category toggles (which categories to show)
  showContradiction Boolean  @default(true)
  showClarify       Boolean  @default(true)
  showNextStep      Boolean  @default(true)
  showRecall        Boolean  @default(true)
  // Category engagement stats for preference learning
  categoryStats     Json? // { contradiction: { shown: 0, engaged: 0 }, ... }
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// Cross-Session Memory for OSQR
// ============================================

// Stores summaries of conversations for long-term memory
model ConversationSummary {
  id          String   @id @default(cuid())
  workspaceId String
  threadId    String?  // Optional link to source thread
  summary     String   // AI-generated summary of the conversation
  topics      String[] // Key topics discussed (for retrieval)
  keyFacts    Json?    // Extracted facts: { userName, workingOn, preferences, etc. }
  messageCount Int     @default(0) // How many messages were summarized
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([workspaceId])
  @@index([workspaceId, createdAt])
}

// ============================================
// Daily Budget Tracking (Throttle System)
// ============================================

// Tracks daily query budget per user with timezone-aware midnight resets
model DailyBudget {
  id                  String   @id @default(cuid())
  userId              String
  tier                String   // lite, pro, master, enterprise
  date                String   // YYYY-MM-DD in user's timezone
  premiumQueriesUsed  Int      @default(0)
  premiumQueriesLimit Int
  economyQueriesUsed  Int      @default(0)
  overagePurchased    Int      @default(0)
  referralBonus       Int      @default(0)
  resetAt             DateTime // Midnight in user's timezone
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId])
}

// User timezone settings for budget reset timing
model UserTimezone {
  id        String   @id @default(cuid())
  userId    String   @unique
  timezone  String   @default("UTC") // IANA timezone string
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// ============================================
// Telemetry System for Behavioral Intelligence
// ============================================

// Telemetry events for behavioral tracking
model TelemetryEvent {
  id          String   @id @default(cuid())
  eventType   String   // mode_selected, session_start, feature_used, etc.
  userIdHash  String?  // Hashed user ID for privacy
  workspaceIdHash String? // Hashed workspace ID
  data        Json     // Event-specific data
  timestamp   DateTime @default(now())

  @@index([eventType])
  @@index([userIdHash])
  @@index([timestamp])
}

// User privacy settings for telemetry
model UserPrivacySetting {
  id              String   @id @default(cuid())
  userId          String   @unique
  privacyTier     String   @default("A") // A, B, or C
  consentVersion  String   // Version of privacy policy consented to
  consentTimestamp DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

// Privacy opt-out history for audit trail
model PrivacyOptOutRecord {
  id        String   @id @default(cuid())
  userId    String
  fromTier  String
  toTier    String
  reason    String?
  createdAt DateTime @default(now())

  @@index([userId])
}

// ============================================
// Decision Tracking (VS Code Extension Support)
// ============================================

// Tracks decisions marked by users across all interfaces
model Decision {
  id             String   @id @default(cuid())
  workspaceId    String
  userId         String
  messageId      String?  // Optional link to source message
  conversationId String?  // Thread/conversation where decision was made
  text           String   // The decision text
  source         String   // 'web' | 'vscode' | 'mobile'
  tags           String[] // User-defined tags
  context        Json?    // Additional context (git branch, file path, etc.)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([workspaceId])
  @@index([userId])
  @@index([source])
  @@index([createdAt])
}

// ============================================
// Token Usage Tracking (VS Code Extension Support)
// ============================================

// Monthly token usage per user per source
model TokenUsage {
  id           String   @id @default(cuid())
  userId       String
  month        String   // YYYY-MM format
  source       String   // 'web' | 'vscode' | 'mobile'
  tokensUsed   Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, month, source])
  @@index([userId])
  @@index([month])
}

// ============================================
// Deep Research System (V1.5)
// ============================================
// @see docs/features/OSQR_DEEP_RESEARCH_SPEC.md

// Research sessions track individual research requests
model ResearchSession {
  id              String   @id @default(cuid())
  userId          String
  workspaceId     String
  projectId       String?

  // Query
  originalQuery   String   // User's original question
  refinedQuery    String?  // OSQR-refined version
  template        String   @default("general") // general, competitor_analysis, market_sizing, etc.
  depth           String   @default("standard") // quick, standard, comprehensive, tribunal

  // Status
  status          String   @default("pending") // pending, scoping, in_progress, completed, failed, cancelled
  phase           Int?     // 1-4 for Tribunal mode
  progress        Int?     // 0-100 percentage

  // Results (stored as JSON)
  reports         Json?    // Array of ModelReport objects
  critiques       Json?    // Array of ModelCritique objects (Tribunal only)
  synthesis       Json?    // ResearchSynthesis object

  // Metadata
  modelsUsed      String[] // ['claude', 'gpt4o', 'gemini']
  tokenCost       Int?     // Total tokens used
  executionTime   Int?     // Milliseconds
  backgroundJob   Boolean  @default(false) // Whether running in background
  inngestEventId  String?  // Inngest event ID for background jobs

  // Staleness tracking
  stalenessDecay  Int      @default(180) // Days until stale
  refreshAt       DateTime? // When to prompt for refresh

  // Failure tracking
  failedModels    Json?    // Array of ModelFailure objects
  error           String?  // Error message if failed

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  completedAt     DateTime?

  @@index([userId])
  @@index([workspaceId])
  @@index([projectId])
  @@index([status])
  @@index([template])
  @@index([depth])
  @@index([createdAt])
  @@index([refreshAt])
}

// ============================================
// User Intelligence Profile (UIP) System (V1.5)
// ============================================
// @see docs/architecture/UIP_SPEC.md

// Main UIP record per user - holds high-level profile state
model UserIntelligenceProfile {
  id                    String             @id @default(cuid())
  userId                String             @unique
  workspaceId           String?            // Primary workspace (users may have multiple)

  // Privacy and consent
  privacyTier           PrivacyTier        @default(A)
  consentedAt           DateTime?          // When user consented to UIP collection

  // Profile maturity
  sessionCount          Int                @default(0)   // Total sessions with this user
  signalCount           Int                @default(0)   // Total signals processed
  firstSeenAt           DateTime           @default(now())
  lastActiveAt          DateTime           @default(now())

  // Reflection state
  lastReflectionAt      DateTime?          // Last time Prospective Reflection ran
  nextReflectionAt      DateTime?          // Scheduled next reflection

  // Progressive elicitation state
  elicitationPhase      Int                @default(0)   // 0 = none, 1-4 = onboarding questions
  questionsAsked        Int                @default(0)   // Total elicitation questions asked
  questionsSkipped      Int                @default(0)   // How many were skipped

  // Computed profile summary (denormalized for fast access)
  profileSummary        Json?              // Quick summary for context injection

  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  // Relations
  dimensions            UIPDimensionScore[]
  facts                 UIPFact[]
  signals               UIPSignal[]
  elicitationResponses  UIPElicitationResponse[]

  @@index([userId])
  @@index([workspaceId])
  @@index([lastActiveAt])
}

// Dimension scores - the 8 UIP domains with confidence tracking
model UIPDimensionScore {
  id              String              @id @default(cuid())
  profileId       String

  // Domain identification
  tier            UIPTier             // FOUNDATION, STYLE, DYNAMICS
  domain          UIPDomain           // IDENTITY, GOALS, COGNITIVE_STYLE, etc.

  // Score with confidence
  value           Json                // Domain-specific structured value
  confidence      Float               @default(0.5)  // 0.0 - 1.0
  decayRate       Float               @default(0.2)  // Per 30 days

  // Source attribution
  sources         UIPSource[]         // What contributed to this score
  sourceCount     Int                 @default(0)    // How many signals formed this

  // Timestamps
  lastUpdatedAt   DateTime            @default(now())
  lastDecayedAt   DateTime            @default(now())

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  profile         UserIntelligenceProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, domain])
  @@index([profileId])
  @@index([domain])
  @@index([confidence])
}

// Individual facts extracted from signals
model UIPFact {
  id              String              @id @default(cuid())
  profileId       String

  // Fact identification
  domain          UIPDomain           // Which domain this fact informs
  factType        String              // "name", "role", "preference", "goal", etc.
  key             String              // Unique key within type (e.g., "communication.verbosity")
  value           String              // The fact value

  // Confidence and validity
  confidence      Float               @default(0.5)
  source          UIPSource           // How we learned this
  decayRate       Float               @default(0.2)

  // PKV override tracking
  isExplicit      Boolean             @default(false)  // From PKV or direct elicitation
  explicitSource  String?             // "pkv", "elicitation", "user_correction"

  // Timestamps
  firstSeenAt     DateTime            @default(now())
  lastConfirmedAt DateTime            @default(now())
  expiresAt       DateTime?           // For time-bound facts

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  profile         UserIntelligenceProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, factType, key])
  @@index([profileId])
  @@index([domain])
  @@index([factType])
  @@index([confidence])
}

// Raw signals before processing into facts/dimensions
model UIPSignal {
  id              String              @id @default(cuid())
  profileId       String

  // Signal identification
  signalType      String              // "mode_selection", "message_length", "retry_pattern", etc.
  category        UIPSignalCategory   // Which category of signal

  // Signal data
  data            Json                // Signal-specific payload
  strength        Float               @default(0.5)  // How strong this signal is

  // Context
  sessionId       String?             // Which session this came from
  messageId       String?             // Which message triggered this

  // Processing state
  processed       Boolean             @default(false)
  processedAt     DateTime?

  createdAt       DateTime            @default(now())

  profile         UserIntelligenceProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([signalType])
  @@index([category])
  @@index([processed])
  @@index([createdAt])
}

// Elicitation question responses
model UIPElicitationResponse {
  id              String              @id @default(cuid())
  profileId       String

  // Question tracking
  questionId      String              // Stable question identifier
  question        String              // The question text asked
  domain          UIPDomain           // Which domain this informs

  // Response
  response        String?             // User's answer (null if skipped)
  skipped         Boolean             @default(false)

  // Context
  sessionNumber   Int                 // Which session this was asked in
  phase           Int                 // Onboarding phase (1-4)

  createdAt       DateTime            @default(now())

  profile         UserIntelligenceProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, questionId])
  @@index([profileId])
  @@index([domain])
}

// ============================================
// UIP Enums
// ============================================

enum PrivacyTier {
  A   // Session-only, minimal collection
  B   // Full UIP, cross-session learning
  C   // Full UIP + anonymized global learning
}

enum UIPTier {
  FOUNDATION  // Identity, Goals & Values
  STYLE       // Cognitive Processing, Communication, Expertise
  DYNAMICS    // Behavioral Patterns, Relationship State, Decision Friction
}

enum UIPDomain {
  // Foundation tier
  IDENTITY_CONTEXT
  GOALS_VALUES
  // Style tier
  COGNITIVE_STYLE
  COMMUNICATION_PREFS
  EXPERTISE_CALIBRATION
  // Dynamics tier
  BEHAVIORAL_PATTERNS
  RELATIONSHIP_STATE
  DECISION_FRICTION
}

enum UIPSource {
  EXPLICIT_PKV        // User-entered in PKV (confidence: 1.0)
  ELICITATION         // Direct answer to OSQR question (confidence: 0.95)
  BEHAVIORAL_REPEATED // 3+ behavioral observations (confidence: 0.8)
  BEHAVIORAL_SINGLE   // Single behavioral signal (confidence: 0.5)
  DOC_STYLE           // Document style inference (confidence: 0.6)
}

enum UIPSignalCategory {
  // Behavioral (telemetry-based)
  MODE_SELECTION      // Which mode they choose
  SESSION_TIMING      // When/how long they work
  RETRY_PATTERN       // How often they retry/abort
  LATENCY_TOLERANCE   // How long they wait
  REFINEMENT_USAGE    // How often they refine
  // Content (message-based)
  MESSAGE_STYLE       // Length, structure, tone
  QUESTION_SOPHISTICATION // Complexity of questions
  VOCABULARY_DENSITY  // Technical language use
  FEEDBACK_SIGNALS    // Corrections, praise, frustration
  // Interaction
  DECISION_MENTIONS   // When they mention decisions
  GOAL_REFERENCES     // When they reference goals
  PREFERENCE_STATEMENTS // Explicit preference mentions
}

// Monthly Tribunal usage tracking per user
// Master tier: 3 sessions included, packs can be purchased
model TribunalUsage {
  id              String   @id @default(cuid())
  userId          String
  month           String   // YYYY-MM format

  sessionsUsed    Int      @default(0)
  sessionsIncluded Int     @default(3) // Monthly allocation
  packsPurchased  Int      @default(0) // Number of pack sessions purchased

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, month])
  @@index([userId])
  @@index([month])
}

// Tribunal pack purchases (Stripe integration)
model TribunalPackPurchase {
  id              String   @id @default(cuid())
  userId          String
  packSize        Int      // 1, 5, or 10
  price           Int      // Price in cents
  stripePaymentId String?  // Stripe payment intent ID
  status          String   @default("pending") // pending, completed, failed, refunded

  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([status])
}

// ============================================
// User Feedback System (V1 Polish)
// ============================================
// @see docs/builds/V1_POLISH_BUILD_PLAN.md

model UserFeedback {
  id              String   @id @default(cuid())
  userId          String
  workspaceId     String?

  // Feedback content
  rating          Int?     // 1-5 scale, null for text-only feedback
  sentiment       String?  // positive, negative, neutral
  message         String?  // Optional text feedback

  // Source tracking (for training pattern)
  source          FeedbackSource

  // Context
  messageId       String?  // Which message triggered feedback
  conversationId  String?  // Which conversation
  responseMode    String?  // quick, thoughtful, contemplate
  pageUrl         String?  // Where user was when feedback submitted

  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([source])
  @@index([sentiment])
  @@index([createdAt])
}

enum FeedbackSource {
  BUTTON          // Clicked feedback button
  NATURAL_LANGUAGE // Said "leave feedback" or similar in chat
  RESPONSE_RATING // Thumbs up/down on response
}

// ============================================
// Testimonial System
// ============================================
// User-submitted testimonials for marketing website

model Testimonial {
  id          String            @id @default(cuid())
  userId      String
  content     String            @db.Text  // The testimonial quote
  displayName String?           // How user wants to be attributed (optional)
  role        String?           // e.g., "Startup Founder" (optional)
  status      TestimonialStatus @default(PENDING)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

enum TestimonialStatus {
  PENDING   // Awaiting review
  APPROVED  // Ready for website
  REJECTED  // Not suitable
}

// ============================================
// Referral System (V1.5)
// ============================================
// Permanent 5% token bonus per successful referral (capped at 50%)
// A user is "referred" when they sign up with someone's referral code
// A referral "converts" when the referred user becomes a paying customer

model Referral {
  id            String    @id @default(cuid())
  referrerId    String    // User who made the referral
  referredId    String    @unique // User who was referred (each user can only be referred once)
  referralCode  String    // The code that was used
  status        ReferralStatus @default(PENDING)
  convertedAt   DateTime? // When referred user became paying
  bonusApplied  Boolean   @default(false) // Whether bonus was applied to referrer
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  referrer      User      @relation("ReferralsMade", fields: [referrerId], references: [id], onDelete: Cascade)
  referred      User      @relation("ReferralsReceived", fields: [referredId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([referralCode])
  @@index([status])
}

enum ReferralStatus {
  PENDING    // User signed up but hasn't paid
  CONVERTED  // User became a paying customer
  EXPIRED    // User never converted (e.g., after 90 days)
}

// ============================================
// Depth-Aware Intelligence System (V1.6)
// ============================================
// @see docs/builds/DEPTH_AWARE_INTELLIGENCE_BUILD.md
//
// Three-layer knowledge system:
// - Layer 1: Always-on (inventory, cache) - milliseconds
// - Layer 2: Awareness scan (topic overlap) - fast
// - Layer 3: Deep retrieval (full PKV search) - expensive

// Document Inventory - lightweight awareness of vault contents
// Allows OSQR to know WHAT exists without reading documents
model DocumentInventory {
  id              String   @id @default(cuid())
  userId          String
  documentId      String   @unique

  // Lightweight metadata (always loaded)
  title           String
  fileName        String
  fileType        String
  uploadedAt      DateTime
  updatedAt       DateTime @updatedAt

  // Auto-generated summaries (created on upload)
  autoSummary     String   @db.Text  // 2-3 sentence summary via Haiku
  topicTags       String[] // Auto-extracted topics

  // Clustering for fast relevance scoring
  topicClusterId  String?
  clusterCentroid Unsupported("vector")? // Embedding of document's "center"

  // Relations
  cluster         TopicCluster? @relation(fields: [topicClusterId], references: [id])

  @@index([userId])
  @@index([topicClusterId])
}

// Topic clusters group related documents for fast relevance detection
model TopicCluster {
  id          String   @id @default(cuid())
  userId      String
  name        String   // Auto-generated cluster name
  centroid    Unsupported("vector")? // Average embedding of cluster
  documentCount Int    @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Rebalancing tracking
  lastRebalancedAt DateTime?
  documentsSinceRebalance Int @default(0) // Trigger rebalance at 20

  documents   DocumentInventory[]

  @@index([userId])
}

// Semantic Answer Cache - remembers Q&A pairs
// Supports both exact match (hash) and similar match (embedding)
model AnswerCache {
  id                String            @id @default(cuid())

  // Scope: GLOBAL (OSQR-wide) or USER (per-user)
  scope             AnswerCacheScope
  userId            String?           // null for GLOBAL scope

  // The cached Q&A pair
  questionHash      String            // SHA-256 of normalized question (exact match)
  questionText      String            @db.Text
  questionEmbedding Unsupported("vector")? // For similar match
  answerText        String            @db.Text

  // Confidence & validity
  confidenceScore   Float             @default(1.0)  // Decays over time
  createdAt         DateTime          @default(now())
  lastUsedAt        DateTime          @default(now())
  lastValidatedAt   DateTime          @default(now())
  expiresAt         DateTime?

  // Invalidation tracking
  isValid           Boolean           @default(true)
  invalidatedAt     DateTime?
  invalidationReason String?

  // Source traceability
  sourceDocumentIds String[]  // Which docs informed this answer
  sourceConversationId String?

  // Usage analytics
  hitCount          Int               @default(0)
  acceptanceRate    Float?            // Did users accept or ask follow-up?
  lastHitAt         DateTime?

  // Invalidation events (for audit trail)
  invalidationEvents CacheInvalidationEvent[]

  @@unique([scope, questionHash])
  @@index([userId])
  @@index([scope])
  @@index([isValid])
  @@index([userId, lastUsedAt]) // For LRU eviction
  @@index([lastHitAt]) // For tracking stale entries
}

enum AnswerCacheScope {
  GLOBAL  // OSQR-wide answers (modes, pricing, features)
  USER    // This user's previously answered questions
}

// Cache invalidation events for audit trail
model CacheInvalidationEvent {
  id            String              @id @default(cuid())
  cacheEntryId  String

  triggerType   InvalidationTrigger
  triggerSource String?             // documentId, userId, etc.
  reason        String

  createdAt     DateTime            @default(now())

  cacheEntry    AnswerCache         @relation(fields: [cacheEntryId], references: [id], onDelete: Cascade)

  @@index([cacheEntryId])
  @@index([triggerType])
  @@index([createdAt])
}

enum InvalidationTrigger {
  TIME_DECAY          // Answer too old (confidence dropped)
  DOCUMENT_CHANGE     // Source document was updated
  DOCUMENT_ADDED      // New doc on same topic uploaded
  USER_CORRECTION     // User said "that's wrong"
  SEMANTIC_CONFLICT   // New info contradicts cached answer
  LRU_EVICTION        // Evicted due to cache size limits
  MANUAL              // Admin invalidation
}

// ============================================
// OSCAR LAB - STRUCTURED FEEDBACK SYSTEM
// ============================================

// Lab membership and engagement tracking
model LabMember {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Engagement level
  tier            LabTier  @default(EXPLORER)
  joinedAt        DateTime @default(now())

  // Progress tracking
  challengesCompleted  Int @default(0)
  feedbackScore        Int @default(0)
  streakDays           Int @default(0)
  lastActiveAt         DateTime?

  // Preferences
  weeklyDigest         Boolean @default(true)
  challengeReminders   Boolean @default(true)

  // Relations
  challengeResponses   ChallengeResponse[]
  deepDiveResponses    DeepDiveResponse[]
  quickReactions       QuickReaction[]

  @@index([tier])
  @@index([feedbackScore])
}

enum LabTier {
  EXPLORER
  CONTRIBUTOR
  INSIDER
}

// Quick inline reactions (Tier 1)
model QuickReaction {
  id              String   @id @default(cuid())

  labMemberId     String
  labMember       LabMember @relation(fields: [labMemberId], references: [id], onDelete: Cascade)

  // What they're reacting to
  messageId       String?
  message         ChatMessage? @relation(fields: [messageId], references: [id], onDelete: SetNull)
  threadId        String?

  // The reaction
  reaction        ReactionType
  category        FeedbackCategory?
  comment         String?  @db.Text

  // Context capture
  responseMode    String?
  modelUsed       String?
  hadPanelDiscussion Boolean @default(false)
  retrievalUsed   Boolean @default(false)

  createdAt       DateTime @default(now())

  @@index([labMemberId])
  @@index([reaction])
  @@index([category])
  @@index([createdAt])
}

enum ReactionType {
  THUMBS_UP
  THUMBS_DOWN
  MISSED_SOMETHING
  UNEXPECTED_GOOD
  WRONG_MODE
}

enum FeedbackCategory {
  INTENT_UNDERSTANDING
  RESPONSE_QUALITY
  MODE_CALIBRATION
  KNOWLEDGE_RETRIEVAL
  PERSONALIZATION
  CAPABILITY_GAP
}

// Guided challenges (Tier 2)
model Challenge {
  id              String   @id @default(cuid())

  // Challenge definition
  title           String
  description     String   @db.Text
  category        FeedbackCategory

  // The task
  promptToTry     String?  @db.Text
  compareMode     Boolean  @default(false)
  modesCompare    String[]

  // Questions to answer after
  questions       Json     // Array of ChallengeQuestion objects

  // Targeting
  targetTier      LabTier?
  targetModes     String[]
  prerequisiteId  String?

  // Lifecycle
  status          ChallengeStatus @default(DRAFT)
  publishedAt     DateTime?
  expiresAt       DateTime?

  // Metadata
  estimatedMinutes Int @default(5)
  pointsReward     Int @default(10)

  // Relations
  responses       ChallengeResponse[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status])
  @@index([category])
  @@index([publishedAt])
}

enum ChallengeStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

// User's response to a challenge
model ChallengeResponse {
  id              String   @id @default(cuid())

  challengeId     String
  challenge       Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  labMemberId     String
  labMember       LabMember @relation(fields: [labMemberId], references: [id], onDelete: Cascade)

  // Their answers
  answers         Json

  // If it was a comparison challenge
  preferredMode   String?
  comparisonNotes String?  @db.Text

  // Context
  threadId        String?
  timeSpentSeconds Int?

  // Quality signals
  thoughtfulness  Int?
  flagged         Boolean  @default(false)

  createdAt       DateTime @default(now())

  @@unique([challengeId, labMemberId])
  @@index([challengeId])
  @@index([labMemberId])
  @@index([createdAt])
}

// Deep dive feedback forms (Tier 3)
model DeepDiveForm {
  id              String   @id @default(cuid())

  // Form definition
  title           String
  description     String   @db.Text
  category        FeedbackCategory

  // Form structure
  sections        Json     // Array of FormSection objects

  // Targeting
  targetTier      LabTier?
  triggerAfter    String?

  // Lifecycle
  status          ChallengeStatus @default(DRAFT)

  // Metadata
  estimatedMinutes Int @default(15)
  pointsReward     Int @default(50)

  // Relations
  responses       DeepDiveResponse[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// User's response to a deep dive form
model DeepDiveResponse {
  id              String   @id @default(cuid())

  formId          String
  form            DeepDiveForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  labMemberId     String
  labMember       LabMember @relation(fields: [labMemberId], references: [id], onDelete: Cascade)

  // Their answers
  answers         Json

  // Quality
  thoughtfulness  Int?
  flagged         Boolean  @default(false)
  adminNotes      String?  @db.Text

  createdAt       DateTime @default(now())

  @@index([formId])
  @@index([labMemberId])
}

// Aggregated insights from feedback
model LabInsight {
  id              String   @id @default(cuid())

  // What this insight is about
  category        FeedbackCategory
  subcategory     String?

  // The insight
  title           String
  summary         String   @db.Text

  // Evidence
  sampleSize      Int
  sentiment       Float
  confidence      Float

  // Source data
  sourceReactions Int      @default(0)
  sourceChallenges Int     @default(0)
  sourceDeepDives Int      @default(0)

  // Action tracking
  status          LabInsightStatus @default(NEW)
  actionTaken     String?  @db.Text
  resolvedAt      DateTime?

  // Time window
  periodStart     DateTime
  periodEnd       DateTime

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([category])
  @@index([status])
  @@index([createdAt])
}

enum LabInsightStatus {
  NEW
  REVIEWING
  ACTIONABLE
  IN_PROGRESS
  RESOLVED
  WONT_FIX
}
